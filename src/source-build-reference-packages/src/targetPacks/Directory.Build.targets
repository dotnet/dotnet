<Project>

  <Import Project="..\..\Directory.Build.targets" />
  <Import Project="$(ManualNuspecTargets)" />
  <Import Project="$(RepositoryEngineeringDir)ILTooling.targets" />

  <Target Name="BuildTargetingPackIlSrc" DependsOnTargets="ResolveIlToolPaths">
    <Message Importance="High" Text="[$([System.DateTime]::Now.ToString('HH:mm:ss.ff'))] Begin $(MSBuildProjectName) -> $(TFMPackTempOutputDir)..." />
    <MakeDir Directories="@(TargetingPackSrc->'$(TFMPackTempOutputDir)%(RecursiveDir)')" />

    <ItemGroup>
      <IndividualFileProject Include="$(MSBuildProjectFullPath)"
        Properties="IlFile=%(TargetingPackSrc.Identity);OutputFile=$(TFMPackTempOutputDir)%(TargetingPackSrc.RelativeOutputAssemblyFile)" />
    </ItemGroup>

    <MSBuild Projects="@(IndividualFileProject)"
             Targets="BuildIlFile"
             BuildInParallel="true"
             StopOnFirstFailure="true" />

    <Message Importance="High" Text="[$([System.DateTime]::Now.ToString('HH:mm:ss.ff'))] $(MSBuildProjectName) -> $(TFMPackTempOutputDir) DONE" />
  </Target>

  <Target Name="BuildIlFile" DependsOnTargets="ResolveIlToolPaths">
    <Error Condition="'$(IlasmPath)' == ''" Text="The 'IlasmPath' property must be set." />

    <Exec Command="$(IlasmPath) $(IlFile) -dll -quiet -nologo &quot;-output=$(OutputFile)&quot;"
          IgnoreStandardErrorWarningFormat="true"
          CustomErrorRegularExpression=": error : " />
    </Target>

  <Target Name="Build" DependsOnTargets="GetProjectSrc;BuildTargetingPackIlSrc" />

</Project>
