<Project>

  <Choose>
    <When Condition="'$(DotNetBuildSourceOnly)' == 'true' and '$(TargetFramework)' != 'net$(BundledNETCoreAppTargetFrameworkVersion)'">
      <!-- Disable restoring transitive aspnetcore and windowsdesktop targeting packs to avoid unnecessary dependencies. -->
      <PropertyGroup>
        <DisableTransitiveFrameworkReferenceDownloads>true</DisableTransitiveFrameworkReferenceDownloads>
      </PropertyGroup>

      <ItemGroup>
        <!-- Downgrade targeting pack versions to X.0.0 as only those are provided by SBRP. -->
        <KnownFrameworkReference Update="@(KnownFrameworkReference->WithMetadataValue('Identity', 'Microsoft.NETCore.App'))">
          <TargetingPackVersion Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(TargetFramework)', '^net\d+\.0$'))">$([System.Text.RegularExpressions.Regex]::Match('%(TargetFramework)', '\d+').Value).0.0</TargetingPackVersion>
        </KnownFrameworkReference>
        <KnownFrameworkReference Update="@(KnownFrameworkReference->WithMetadataValue('Identity', 'Microsoft.AspNetCore.App'))">
          <TargetingPackVersion Condition="'%(TargetFramework)' == 'net6.0'">6.0.2</TargetingPackVersion>
        </KnownFrameworkReference>

        <!-- This is hacky as it uses newer analyzers from the current framework for downlevel TFMs.
            Necessary as the non-current targeting packs are missing analyzers which result in compiler errors when using i.e. Regex or LibraryImport attributes. -->
        <Analyzer Include="$(NetCoreTargetingPackRoot)\Microsoft.NETCore.App.Ref\$(BundledNETCoreAppPackageVersion)\analyzers\dotnet\cs\*.dll" Condition="'$(Language)' == 'C#'" />
      </ItemGroup>
    </When>
  </Choose>

</Project>