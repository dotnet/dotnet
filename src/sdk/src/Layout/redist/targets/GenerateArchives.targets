<Project>

  <Target Name="GenerateArchives"
          DependsOnTargets="GenerateInstallerLayout"
          AfterTargets="AfterBuild">
    <!-- When running in Docker under a Windows host, tar is warning "file changed as we read it" for several files and returning exit code 1.
         So this flag allows that to be ignored. -->
    <PropertyGroup Condition="'$(IgnoreTarExitCode)' == ''">
      <IgnoreTarExitCode>false</IgnoreTarExitCode>
      <IgnoreTarExitCode Condition="'$(DOTNET_CORESDK_IGNORE_TAR_EXIT_CODE)' == '1'">true</IgnoreTarExitCode>
    </PropertyGroup>

    <!-- Ensure output directories are created -->
    <MakeDir Directories="$(ArtifactsShippingPackagesDir);$(ArtifactsNonShippingPackagesDir)" />

    <!-- Debug: List directory structure before archiving -->
    <Message Text="=== Checking for files with 11.0.100-ci not under sdk\ ===" Importance="High" Condition="'$(OSName)' == 'win'" />
    <Exec Command="cmd /c &quot;dir /s /b &quot;$(RedistInstallerLayoutPath)&quot; | findstr /i &quot;11.0.100-ci&quot; | findstr /v /i &quot;\\sdk\\&quot;&quot;"
          Condition="'$(OSName)' == 'win'"
          ContinueOnError="true"
          IgnoreExitCode="true" />
    <Message Text="=== End directory listing ===" Importance="High" Condition="'$(OSName)' == 'win'" />

    <!-- Create .zip files on Windows -->
    <ZipFileCreateFromDirectory
        Condition=" '$(OSName)' == 'win' "
        SourceDirectory="$(RedistInstallerLayoutPath)"
        DestinationArchive="$(ArtifactsShippingPackagesDir)$(ArtifactNameWithVersionCombinedHostHostFxrFrameworkSdk).zip"
        OverwriteDestination="true" />

    <!-- Create .tar.gz files on all platforms -->
    <TarGzFileCreateFromDirectory
        SourceDirectory="$(RedistInstallerLayoutPath)"
        DestinationArchive="$(ArtifactsShippingPackagesDir)$(ArtifactNameWithVersionCombinedHostHostFxrFrameworkSdk).tar.gz"
        OverwriteDestination="true"
        IgnoreExitCode="$(IgnoreTarExitCode)" />
  </Target>

</Project>
