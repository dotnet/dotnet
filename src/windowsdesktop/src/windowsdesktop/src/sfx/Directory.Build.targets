<Project>

  <Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory).., Directory.Build.targets))\Directory.Build.targets" />

  <ItemGroup>
    <KnownFrameworkReference
      Update="Microsoft.NETCore.App">
      <DefaultRuntimeFrameworkVersion Condition="'%(TargetFramework)' == '$(NetCurrent)'">$(MicrosoftNETCoreAppRefVersion)</DefaultRuntimeFrameworkVersion>
      <LatestRuntimeFrameworkVersion Condition="'%(TargetFramework)' == '$(NetCurrent)'">$(MicrosoftNETCoreAppRefVersion)</LatestRuntimeFrameworkVersion>
      <TargetingPackVersion Condition="'%(TargetFramework)' == '$(NetCurrent)'">$(MicrosoftNETCoreAppRefVersion)</TargetingPackVersion>
    </KnownFrameworkReference>
    <KnownCrossgen2Pack
      Update="Microsoft.NETCore.App.Crossgen2">
      <Crossgen2PackVersion Condition="'%(TargetFramework)' == '$(NetCurrent)'">$(MicrosoftNETCoreAppRefVersion)</Crossgen2PackVersion>
    </KnownCrossgen2Pack>
    <KnownFrameworkReference Remove="Microsoft.AspNetCore.App" />
    <KnownFrameworkReference Remove="Microsoft.WindowsDesktop.App" />
    <KnownFrameworkReference Remove="Microsoft.WindowsDesktop.App.WindowsForms" />
    <KnownFrameworkReference Remove="Microsoft.WindowsDesktop.App.WPF" />

  </ItemGroup>

  <!-- Redistribute package content from other nuget packages. -->
  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.Wpf.GitHub" />
    <PackageReference Include="Microsoft.Private.Winforms" GeneratePathProperty="true" />
    <PackageReference Include="Microsoft.Internal.Runtime.WindowsDesktop.Transport" />
  </ItemGroup>

  <!-- Profile is intentionally undefined so that the reference will only be included when no profile is specified i.e. both WPF and WindowsForms are in use https://github.com/dotnet/wpf/blob/bbfc24fd13804a191e20064acd599b0a359092df/packaging/Microsoft.NET.Sdk.WindowsDesktop/targets/Microsoft.NET.Sdk.WindowsDesktop.props#L45-L46 -->
  <ItemGroup>
    <FrameworkListFileClass Include="WindowsFormsIntegration.dll" />
  </ItemGroup>

  <!-- References that are common to both WinForms and WPF -->
  <ItemGroup>
    <FrameworkListFileClass Include="Accessibility.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="Microsoft.Win32.Registry.AccessControl.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="Microsoft.Win32.SystemEvents.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.CodeDom.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Configuration.ConfigurationManager.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Diagnostics.EventLog.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Diagnostics.PerformanceCounter.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.DirectoryServices.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Formats.Nrbf.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.IO.Packaging.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Resources.Extensions.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Security.Cryptography.Pkcs.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Security.Cryptography.ProtectedData.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Security.Cryptography.Xml.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Security.Permissions.dll" Profile="WindowsForms;WPF" />
    <FrameworkListFileClass Include="System.Windows.Extensions.dll" Profile="WindowsForms;WPF" />
  </ItemGroup>

  <!--
    Windows Forms specific references
    see: https://github.com/dotnet/winforms/tree/main/pkg/Microsoft.Private.Winforms/sdk/dotnet-windowsdesktop
    -->
  <Import Project="$(PkgMicrosoft_Private_Winforms)\sdk\dotnet-windowsdesktop\System.Windows.Forms.FileClassification.props"
          Condition="Exists('$(PkgMicrosoft_Private_Winforms)')" />

  <!-- WPF specific references -->
  <ItemGroup>
    <FrameworkListFileClass Include="PresentationCore.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.Aero.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.Aero2.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.AeroLite.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.Classic.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.Luna.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationFramework.Royale.dll" Profile="WPF" />
    <FrameworkListFileClass Include="PresentationUI.dll" Profile="WPF" />
    <FrameworkListFileClass Include="ReachFramework.dll" Profile="WPF" />
    <FrameworkListFileClass Include="System.Printing.dll" Profile="WPF" />
    <FrameworkListFileClass Include="System.Windows.Controls.Ribbon.dll" Profile="WPF" />
    <FrameworkListFileClass Include="System.Windows.Input.Manipulations.dll" Profile="WPF" />
    <FrameworkListFileClass Include="System.Windows.Presentation.dll" Profile="WPF" />
    <FrameworkListFileClass Include="System.Windows.Primitives.dll" Profile="WPF" />
    <FrameworkListFileClass Include="System.Xaml.dll" Profile="WPF" />
    <FrameworkListFileClass Include="UIAutomationClient.dll" Profile="WPF" />
    <FrameworkListFileClass Include="UIAutomationClientSideProviders.dll" Profile="WPF" />
    <FrameworkListFileClass Include="UIAutomationProvider.dll" Profile="WPF" />
    <FrameworkListFileClass Include="UIAutomationTypes.dll" Profile="WPF" />
    <FrameworkListFileClass Include="WindowsBase.dll" Profile="WPF" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.Build.Tasks.Templating" />
    <PackageReference Include="Microsoft.DotNet.Build.Tasks.Archives" />
  </ItemGroup>

  <ItemGroup>
    <ExcludeFromDuplicateTypes Include="PresentationFramework.Aero" />
    <ExcludeFromDuplicateTypes Include="PresentationFramework.Aero2" />
    <ExcludeFromDuplicateTypes Include="PresentationFramework.AeroLite" />
    <ExcludeFromDuplicateTypes Include="PresentationFramework.Classic" />
    <ExcludeFromDuplicateTypes Include="PresentationFramework.Luna" />
    <ExcludeFromDuplicateTypes Include="PresentationFramework.Royale" />
  </ItemGroup>
  
  <ItemGroup>
    <!-- There is a known cycle. More info at https://github.com/dotnet/wpf/issues/607 -->
    <IgnoredReference Include="PresentationFramework" />
    <IgnoredReference Include="ReachFramework" />
    <IgnoredReference Include="System.Printing" />
    
    <!-- C++/CLI tooling adds an assemblyref to System.Runtime.InteropServices.WindowsRuntime even though it is unused.
        Ignore validating this reference when we validate the runtime and ref pack closures since we never use the assembly
        and it was removed in .NET 5.
    -->
    <IgnoredReference Include="System.Runtime.InteropServices.WindowsRuntime" />
  </ItemGroup>

  <Target Name="ReturnProductVersion" Returns="$(Version)" />

  <Target Name="CreatePackageOverrides">
    <PropertyGroup>
      <PackageOverridesInputPath>$(MSBuildThisFileDirectory)PackageOverrides.txt</PackageOverridesInputPath>
      <PackageOverridesOutputPath>$(BaseOutputPath)PackageOverrides.txt</PackageOverridesOutputPath>

      <!-- Add the RuntimeWindowsDesktopPackageLibrary item information from the Microsoft.Internal.Runtime.WindowsDesktop.Transport package. -->
      <RuntimeWindowsDesktopPackageLibraries>@(RuntimeWindowsDesktopPackageLibrary->'%(PackageId)|%(PackageVersion)', '
')</RuntimeWindowsDesktopPackageLibraries>
      <WinformsWindowsDesktopPackageLibraries>@(WinformsWindowsDesktopPackageLibrary->'%(PackageId)|%(PackageVersion)', '
')</WinformsWindowsDesktopPackageLibraries>
    </PropertyGroup>

    <!-- Every file we add to package overrides must be exposed for FrameworkListFileClass Profile="WindowsForms;WPF"
         Emit an error if any are not. -->
    <ItemGroup>
      <_allProfileFiles Include="%(FrameworkListFileClass.FileName)" Condition="'%(FrameworkListFileClass.Profile)' == 'WindowsForms;WPF'" />
      <_packageOverrideErrors Include="@(RuntimeWindowsDesktopPackageLibrary->'%(PackageId)');@(WinformsWindowsDesktopPackageLibrary->'%(PackageId)')"
                              Exclude="@(_allProfileFiles)"/>
    </ItemGroup>

    <Error Text="Package override(s) '@(_packageOverrideErrors)' must be exposed for Profile='WindowsForms;WPF'.  Please update their FrameworkListFileClass item(s)." 
           Condition="'@(_packageOverrideErrors)' != ''" />

    <ItemGroup>
      <CreatePackageOverridesTemplateProperty Include="RuntimeWindowsDesktopPackageLibraries=$(RuntimeWindowsDesktopPackageLibraries)" />
      <CreatePackageOverridesTemplateProperty Include="WinformsWindowsDesktopPackageLibraries=$(WinformsWindowsDesktopPackageLibraries)" />
    </ItemGroup>

    <GenerateFileFromTemplate
      TemplateFile="$(PackageOverridesInputPath)"
      Properties="@(CreatePackageOverridesTemplateProperty)"
      OutputPath="$(PackageOverridesOutputPath)" />

    <ItemGroup>
      <PackageOverridesFile Include="$(PackageOverridesOutputPath)" />
    </ItemGroup>
  </Target>

</Project>
