<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:bal="http://wixtoolset.org/schemas/v4/wxs/bal" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Bundle Name="$(SdkBrandName) $(Version) ($(TargetArchitecture))" 
          Manufacturer="$(Manufacturer)" 
          Version="$(BundleVersion)" 
          UpgradeCode="$(UpgradeCode)"
          ProviderKey="$(UpgradeCode)"
          AboutUrl="https://aka.ms/dotnet-windows-desktop"
          Compressed="yes">

  <!-- Related bundle for upgrade scenarios -->
  <RelatedBundle Id="$(UpgradeCode)" Action="Upgrade" />

  <!-- Legacy bundles authored before the deterministic UpgradeCode seed.
    Keep these explicit IDs so RC1/preview installers are replaced instead of installing SxS. -->
  <RelatedBundle Id="{42091558-a8d7-4e3a-885b-aa746c7ed165}" Action="Upgrade" />
  <RelatedBundle Id="{39A4DBC3-2C46-4F31-9C0D-E4B1B4B526DE}" Action="Upgrade" />
  <RelatedBundle Id="{55414577-5A99-7937-6951-9CCC4BE8857E}" Action="Upgrade" />

    <bal:Condition Message="#(loc.InstallPathx64x86)" Condition="WixBundleInstalled OR (NOT DOTNETHOME_X64 ~= DOTNETHOME_X86) OR DOTNETHOMESIMILARITYCHECKOVERRIDE" />

    <bal:Condition Message="#(loc.InstallPathARM64x86)" Condition="WixBundleInstalled OR (NOT DOTNETHOME_ARM64 ~= DOTNETHOME_X86) OR DOTNETHOMESIMILARITYCHECKOVERRIDE" />

    <!-- Permit same path on non-ARM64 machines since past SDKs always wrote this value -->
    <bal:Condition Message="#(loc.InstallPathARM64x64)" Condition="WixBundleInstalled OR (NOT DOTNETHOME_ARM64 ~= DOTNETHOME_X64) OR (NOT NativeMachine=&quot;$(NativeMachine_arm64)&quot;) OR DOTNETHOMESIMILARITYCHECKOVERRIDE" />

    <BootstrapperApplication>
      <bal:WixStandardBootstrapperApplication LicenseFile="dummyeula.rtf"
                                              LocalizationFile="theme\1033\bundle.wxl"
                                              ShowVersion="yes"
                                              SuppressDowngradeFailure="no"
                                              SuppressOptionsUI="yes"
                                              Theme="rtfLicense"
                                              ThemeFile="bundle.thm" />

      <?foreach lcid in 2052;1028;1029;1031;3082;1033;1036;1040;1041;1042;1045;1046;1049;1055?>
      <Payload Id="PL_bundle_$(lcid)" SourceFile="theme\$(lcid)\bundle.wxl" Name="$(lcid)\bundle.wxl" Compressed="yes" />
      <?endforeach?>

      <Payload Name="DotNetLogo_256x.png" Compressed="yes" SourceFile="DotNetLogo_256x.png" />
      <Payload Name="dotnet.ico" Compressed="yes" SourceFile="dotnet.ico" />
    </BootstrapperApplication>

    <SoftwareTag Regid="microsoft.com" InstallPath="[ProgramFiles6432Folder]dotnet" />

    <!-- MSI installers always write search keys to the 32-bit hive. -->
    <util:RegistrySearch Id="CheckDotnetInstallLocation_x86"
                         Key="SOFTWARE\dotnet\Setup\InstalledVersions\x86"
                         Result="exists"
                         Root="HKLM"
                         Value="InstallLocation"
                         Variable="DotnetInstallLocationExists_x86" />

    <util:RegistrySearch After="CheckDotnetInstallLocation_x86"
                         Condition="DotnetInstallLocationExists_x86"
                         Id="DotnetInstallLocation_x86"
                         Variable="DOTNETHOME_X86"
                         Result="value"
                         Root="HKLM"
                         Key="SOFTWARE\dotnet\Setup\InstalledVersions\x86"
                         Value="InstallLocation" />

    <util:FileSearch Id="DotnetExeSearch_x86"
                     After="DotnetInstallLocation_x86"
                     Variable="DotnetExeExists_x86"
                     Condition="NOT DotnetInstallLocationExists_x86"
                     Result="exists"
                     Path="[ProgramFilesFolder]dotnet\dotnet.exe"/>
    <util:DirectorySearch Id="DotnetExeLocation_x86"
                          After="DotnetExeSearch_x86"
                          Condition="DotnetExeExists_x86"
                          Variable="DOTNETHOME_X86"
                          Path="[ProgramFilesFolder]dotnet"/>

    <?if $(TargetArchitecture)!=x86?>
    <util:RegistrySearch Id="CheckDotnetInstallLocation_x64"
              Variable="DotnetInstallLocationExists_x64"
              Result="exists"
              Root="HKLM"
              Key="SOFTWARE\dotnet\Setup\InstalledVersions\x64"
              Value="InstallLocation" />
    <util:RegistrySearch Id="DotnetInstallLocation_x64"
              After="CheckDotnetInstallLocation_x64"
              Condition="DotnetInstallLocationExists_x64"
              Variable="DOTNETHOME_X64"
              Result="value"
              Root="HKLM"
              Key="SOFTWARE\dotnet\Setup\InstalledVersions\x64"
              Value="InstallLocation" />

    <!-- Check default location when on x64 OS-->
    <util:FileSearch Id="DotnetExeSearch_x64"
              After="DotnetInstallLocation_x64"
              Variable="DotnetExeExists_x64"
              Condition="NOT DotnetInstallLocationExists_x64 AND (NOT NativeMachine OR NativeMachine=&quot;$(NativeMachine_x64)&quot;)"
              Result="exists"
              Path="[ProgramFiles64Folder]dotnet\dotnet.exe"/>
    <util:DirectorySearch Id="DotnetExeLocation_x64"
              After="DotnetExeSearch_x64"
              Condition="DotnetExeExists_x64"
              Variable="DOTNETHOME_X64"
              Path="[ProgramFiles64Folder]dotnet"/>

    <!-- Check alternate location on non-x64 OS -->
    <util:FileSearch Id="DotnetExeSearch_alt_x64"
              After="DotnetInstallLocation_x64"
              Variable="DotnetExeExists_alt_x64"
              Condition="NOT DotnetInstallLocationExists_x64 AND NOT NativeMachine=&quot;$(NativeMachine_x64)&quot;"
              Result="exists"
              Path="[ProgramFiles64Folder]dotnet\x64\dotnet.exe"/>
    <util:DirectorySearch Id="DotnetExeLocation_alt_x64"
              After="DotnetExeSearch_alt_x64"
              Condition="DotnetExeExists_alt_x64"
              Variable="DOTNETHOME_X64"
              Path="[ProgramFiles64Folder]dotnet\x64"/>
    <?endif?>
    <?if $(TargetArchitecture)=arm64?>
    <util:RegistrySearch Id="CheckDotnetInstallLocation_arm64"
              Variable="DotnetInstallLocationExists_arm64"
              Result="exists"
              Root="HKLM"
              Key="SOFTWARE\dotnet\Setup\InstalledVersions\arm64"
              Value="InstallLocation" />
    <util:RegistrySearch Id="DotnetInstallLocation_arm64"
              After="CheckDotnetInstallLocation_arm64"
              Condition="DotnetInstallLocationExists_arm64"
              Variable="DOTNETHOME_ARM64"
              Result="value"
              Root="HKLM"
              Key="SOFTWARE\dotnet\Setup\InstalledVersions\arm64"
              Value="InstallLocation" />

    <util:FileSearch Id="DotnetExeSearch_arm64"
              After="DotnetInstallLocation_arm64"
              Variable="DotnetExeExists_arm64"
              Condition="NOT DotnetInstallLocationExists_arm64"
              Result="exists"
              Path="[ProgramFiles64Folder]dotnet\dotnet.exe"/>
    <util:DirectorySearch Id="DotnetExeLocation_arm64"
              After="DotnetExeSearch_arm64"
              Condition="DotnetExeExists_arm64"
              Variable="DOTNETHOME_ARM64"
              Path="[ProgramFiles64Folder]dotnet"/>
    <?endif?>

    <!-- Registry searches for WindowsDesktop framework detection -->
    <util:RegistrySearch Id="WindowsDesktopFrameworkInstalled"
                         Key="SOFTWARE\dotnet\Setup\InstalledVersions\$(TargetArchitecture)\sharedframework\Microsoft.WindowsDesktop.App"
                         Result="exists"
                         Root="HKLM"
                         Value="10.0.0"
                         Variable="WindowsDesktopFrameworkExists" />

    <util:RegistrySearch After="WindowsDesktopFrameworkInstalled"
                         Condition="WindowsDesktopFrameworkExists"
                         Id="WindowsDesktopFrameworkVersion"
                         Key="SOFTWARE\dotnet\Setup\InstalledVersions\$(TargetArchitecture)\sharedframework\Microsoft.WindowsDesktop.App"
                         Result="value"
                         Root="HKLM"
                         Value="10.0.0"
                         Variable="WindowsDesktopFrameworkInstalledVersion" />

    <!-- Registry search for RC1 bundle detection -->
    <util:RegistrySearch Id="WindowsDesktopRC1BundleInstalled"
                         Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{39A4DBC3-2C46-4F31-9C0D-E4B1B4B526DE}"
                         Result="exists"
                         Root="HKLM"
                         Variable="WindowsDesktopRC1BundleExists" />

    <!-- Registry search for Preview 5 bundle detection -->
    <util:RegistrySearch Id="WindowsDesktopPreview5BundleInstalled"
                         Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{55414577-5A99-7937-6951-9CCC4BE8857E}"
                         Result="exists"
                         Root="HKLM"
                         Variable="WindowsDesktopPreview5BundleExists" />

    <!-- Registry search for current bundle family detection -->
    <util:RegistrySearch Id="WindowsDesktopCurrentBundleInstalled"
                         Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(UpgradeCode)"
                         Result="exists"
                         Root="HKLM"
                         Variable="WindowsDesktopCurrentBundleExists" />

    <!--
        When installing the SDK bundle to a custom location using the commandline parameters, it is intended, not mandatory, that
        both "DOTNETHOME_X86" and "DOTNETHOME_X64" should be used on the commandline and should take this convention:
            DOTNETHOME_X86=<InstallFolder>\x86
            DOTNETHOME_X64=<InstallFolder>\x64
        Example:
            dotnet-sdk-3.0.100-alpha1-009719-win-x64.exe /install DOTNETHOME_X64="D:\dotnet\x64" DOTNETHOME_X86="D:\dotnet\x86" /log "installation.log" /quiet /norestart
    -->
    <Variable Name="DOTNETHOME_X86" bal:Overridable="yes" />
    <Variable Name="DOTNETHOME_X64" bal:Overridable="yes" />
    <Variable Name="DOTNETHOME_ARM64" bal:Overridable="yes" />
    <Variable Name="DOTNETHOME" Type="formatted" Value="[DOTNETHOME_$(PlatformToken)]" bal:Overridable="no" />
    <Variable Name="BUNDLEMONIKER" Type="string" Value="$(SdkBrandName)" bal:Overridable="no" />
    <Variable Name="DOTNETSDKVERSION" Type="string" Value="$(Version)" bal:Overridable="no" />
    <Variable Name="DOTNETRUNTIMEVERSION" Type="string" Value="$(DotNetRuntimeVersion)" bal:Overridable="no" />
    <Variable Name="ASPNETCOREVERSION" Type="string" Value="$(AspNetCoreVersion)" bal:Overridable="no" />
    <Variable Name="WINFORMSANDWPFVERSION" Type="string" Value="$(WinFormsAndWpfVersion)" bal:Overridable="no" />
    <Variable Name="DOTNETHOMESIMILARITYCHECKOVERRIDE" Type="string" Value="" bal:Overridable="yes" />
    <Variable Name="VERSIONMAJOR" Type="string" Value="$(MajorVersion)" bal:Overridable="no" />
    <Variable Name="VERSIONMINOR" Type="string" Value="$(MinorVersion)" bal:Overridable="no" />
    <Variable Name="MINIMUMVSVERSION" Type="string" Value="$(MinimumVSVersion)" bal:Overridable="no" />

    <Chain DisableSystemRestore="yes" ParallelCache="yes">
      <!-- Rollback boundary ensures transaction safety for all MSI packages -->
      <RollbackBoundary Id="WindowsDesktopBoundary" />
      
      <!-- .NET Core components must be installed in dependency order -->
      <!-- These are conditionally included only if the MSI files exist -->
      
      <!-- Host is the base component that everything else depends on -->
      <?if $(var.IncludeRuntimeMSIs) = true ?>
      <MsiPackage 
        Id="DotNetHost"
        SourceFile="$(var.DotNetRedistHostInstaller)"
        Vital="yes"
        Cache="keep"
        DisplayName="Microsoft .NET Host"
        InstallCondition="NOT DotNetHostInstalledVersion$(var.PlatformToken) OR DotNetHostInstalledVersion$(var.PlatformToken) &lt; v$(var.DotNetRuntimeVersion)">
        <MsiProperty Name="DOTNETHOME" Value="[DOTNETHOME]" />
        <MsiProperty Name="ALLOWMSIINSTALL" Value="True" />
      </MsiPackage>
      
      <!-- HostFxr depends on Host -->
      <MsiPackage 
        Id="DotNetHostFxr"
        SourceFile="$(var.DotNetRedistHostfxrInstaller)"
        Vital="yes"
        Cache="keep"
        DisplayName="Microsoft .NET Host FX Resolver"
        InstallCondition="NOT DotNetHostFxrInstalledVersion$(var.PlatformToken) OR DotNetHostFxrInstalledVersion$(var.PlatformToken) &lt; v$(var.DotNetRuntimeVersion)">
        <MsiProperty Name="DOTNETHOME" Value="[DOTNETHOME]" />
        <MsiProperty Name="ALLOWMSIINSTALL" Value="True" />
      </MsiPackage>
      
      <!-- Runtime depends on Host and HostFxr -->
      <MsiPackage 
        Id="DotNetRuntime"
        SourceFile="$(var.DotNetRedistLtsInstaller)"
        Vital="yes"
        Cache="keep"
        DisplayName="Microsoft .NET Runtime"
        InstallCondition="NOT DotNetRuntimeInstalledVersion$(var.PlatformToken) OR DotNetRuntimeInstalledVersion$(var.PlatformToken) &lt; v$(var.DotNetRuntimeVersion)">
        <MsiProperty Name="DOTNETHOME" Value="[DOTNETHOME]" />
        <MsiProperty Name="ALLOWMSIINSTALL" Value="True" />
      </MsiPackage>
      <?endif ?>
      
      <!-- Windows Desktop Runtime depends on all the above .NET Core components -->
      <MsiPackage 
        Id="WindowsDesktopRuntime"
        SourceFile="$(WindowsDesktopRuntimeMsiPath)"
        Vital="yes"
        Cache="keep"
        DisplayName="Microsoft Windows Desktop Runtime"
        InstallCondition="NOT WindowsDesktopRuntimeInstalledVersion OR WindowsDesktopRuntimeInstalledVersion &lt; v$(Version)">
        <MsiProperty Name="DOTNETHOME" Value="[DOTNETHOME]" />
        <MsiProperty Name="ALLOWMSIINSTALL" Value="True" />
        <MsiProperty Name="ARPSYSTEMCOMPONENT" Value="0" />
      </MsiPackage>
    </Chain>
  </Bundle>
</Wix>