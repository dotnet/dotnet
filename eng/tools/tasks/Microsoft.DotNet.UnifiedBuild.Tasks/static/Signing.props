<Project>

  <Import Project="$(RepositoryEngineeringDir)VmrLayout.props" />

  <PropertyGroup>
    <SourceAssetCertificateId>LinuxSign500180PGP</SourceAssetCertificateId>
    <ExternalCertificateId>3PartySHA2</ExternalCertificateId>
    <UseDotNetCertificate>true</UseDotNetCertificate>
  </PropertyGroup>

  <ItemGroup>
    <ItemsToSign Remove="@(ItemsToSign)" />
  </ItemGroup>

  <ItemGroup>
    <!-- Materialize an item list from the property so transforms work -->
    <SignableSourceBuiltAsset Include="$(SignableSourceBuiltAssets)" />
  </ItemGroup>

  <ItemGroup>
    <!-- Sign all of the source built assets -->
    <ItemsToSign Include="@(SignableSourceBuiltAsset)" />
  </ItemGroup>

  <Target Name="SetFileSignInfoForSourceAsset" BeforeTargets="Sign">
    <ItemGroup>
      <SourceBuiltSourceAsset Include="@(SignableSourceBuiltAsset)" Condition="$([System.String]::new('%(Filename)').StartsWith('$(SourceBuiltSourceArtifactName)'))"/>
    </ItemGroup>

    <!-- Don't unpack the source asset and sign it with a detached signature -->
    <ItemGroup>
      <FileSignInfo Include="@(SourceBuiltSourceAsset->'%(Filename)%(Extension)')">
        <CertificateName>$(SourceAssetCertificateId)</CertificateName>
        <DoNotUnpack>true</DoNotUnpack>
      </FileSignInfo>
    </ItemGroup>
  </Target>

  <ItemGroup>
    <!-- Remove after we have rebootstrapped with an arcade change that includes https://github.com/dotnet/arcade/pull/16479 -->
    <CertificatesSignInfo Include="$(SourceAssetCertificateId)" SupportsDetachedSignature="true" />

    <!-- We don't need to code sign .js files because they are not used in Windows Script Host -->
    <FileExtensionSignInfo Update=".js" CertificateName="None" />

    <!-- Sign 3rd party files that end up in the artifacts -->
    <FileSignInfo Include="Humanizer.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Mono.Cecil.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Mono.Cecil.Mdb.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Mono.Cecil.Pdb.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Mono.Cecil.Rocks.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Newtonsoft.Json.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Spectre.Console.dll" CertificateName="$(ExternalCertificateId)" />
    <FileSignInfo Include="Valleysoft.DockerCredsProvider.dll" CertificateName="$(ExternalCertificateId)" />

    <!--
        Skip warning on files that are marked as 3rd party but have .NET copyright:
        "Copyright Â© .NET Foundation and Contributors" or ".NET Foundation and Contributors" 
    -->
    <ItemsToSkip3rdPartyCheck Include="mscorlib.dll" />
    <ItemsToSkip3rdPartyCheck Include="netstandard.dll" />
  </ItemGroup>

</Project>
