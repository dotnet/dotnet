# Yaml task for running "CreateUpdatePR" from Arcade's Microsoft.DotNet.Baselines.Tasks
# See https://github.com/dotnet/arcade/blob/7438a998446e46b92807fe58ca5b3f5a5ecafd78/src/Microsoft.DotNet.Baselines.Tasks/build/Microsoft.DotNet.Baselines.Tasks.targets#L9
# for more information about the target and its parameters
parameters:
- name: targetDirectory
  type: string

- name: updatedBaselineDirectory
  type: string

- name: defaultBaselineContent
  type: string
  default: ''

- name: title
  type: string
  default: ''

- name: unionExclusionsBaselines
  type: boolean
  default: false

steps:
  - script: |
      # Initialize the .NET CLI
      source ./eng/common/tools.sh
      InitializeDotNetCli true

      # Set up additional arguments for the CreateUpdatePR target
      additionalArgs=""
      if [[ -n "${{ parameters.defaultBaselineContent }}" ]]; then
        additionalArgs="$additionalArgs /p:DefaultBaselineContent=${{ parameters.defaultBaselineContent }}"
      fi

      if [[ -n "${{ parameters.title }}" ]]; then
        additionalArgs="$additionalArgs /p:Title=${{ parameters.title }}"
      fi

      # Workaround: stage only Updated* files in a temp folder to prevent CreateUpdatePR from picking up all files.
      # Delete this after the next rebootstrap.
      updatedBaselineDirectory="$(Agent.TempDirectory)/updated-baseline"
      mkdir -p $updatedBaselineDirectory
      cp -r ${{ parameters.updatedBaselineDirectory }}/**/{Updated*,updated*} $updatedBaselineDirectory/ 2>/dev/null || true

      # Workaround: extract the target branch without the refs/heads/ prefix
      # Delete this after the next rebootstrap.
      targetBranch=$(echo "$(Build.SourceBranch)" | sed 's/refs\/heads\///g')

      # Run the CreateUpdatePR target
      $_InitializeDotNetCli/dotnet msbuild $(Build.SourcesDirectory)/test/tests.proj /restore \
        /t:CreateUpdatePR \
        /p:TargetDirectory=${{ parameters.targetDirectory }} \
        /p:UpdatedBaselineDirectory=$updatedBaselineDirectory \
        /p:BuildId=$(Build.BuildId) \
        /p:TargetBranch=$targetBranch \
        /p:UnionExclusionsBaselines=${{ parameters.unionExclusionsBaselines }} \
        ${additionalArgs} \
        /bl:$(Build.StagingDirectory)/BuildLogs/CreateUpdatePR.binlog
    displayName: Create Baseline Update PR
    workingDirectory: $(Build.SourcesDirectory)
    condition: succeededOrFailed()
    env:
      GH_TOKEN: $(BotAccount-dotnet-sb-bot-pat)
