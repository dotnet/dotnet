# This yml is used by these pipelines:
# - dotnet-unified-build (public)
#   https://dev.azure.com/dnceng-public/public/_build?definitionId=278
# - dotnet-unified-build-full (public)
#   https://dev.azure.com/dnceng-public/public/_build?definitionId=303
#   Comment trigger only

# Only run daily on schedule to save resources
trigger: none

pr:
  branches:
    include:
    - main
    - release/*

schedules:
  - cron: "0 1 * * *" # run at 01:00 (UTC)
    branches:
      include:
      - main
    always: false # run only if there were changes since the last successful scheduled run.

parameters:
- name: buildScope
  displayName: 'Build Scope'
  type: string
  default: 'auto'
  values:
    - auto
    - lite
    - full

- name: featureBand
  displayName: 'Target Feature Band'
  type: string
  default: 'Detect by Branch Name'
  values:
    - 'Detect by Branch Name'
    - '1xx'
    - '>= 2xx'

variables:
- name: isScheduleTrigger
  value: ${{ eq(variables['Build.Reason'], 'Schedule') }}

- name: isPRTrigger
  value: ${{ eq(variables['Build.Reason'], 'PullRequest') }}

- ${{ if eq(variables['System.TeamProject'], 'public') }}:
  - name: skipComponentGovernanceDetection  # we run CG on internal builds only
    value: true

  - name: Codeql.Enabled  # we run CodeQL on internal builds only
    value: false

- template: /eng/common/templates/variables/pool-providers.yml@self

stages:
- template: /eng/pipelines/templates/stages/vmr-build.yml
  parameters:
    ${{ if eq(parameters.buildScope, 'auto') }}:
      ${{ if or(eq(variables.isScheduleTrigger, 'true'), contains(variables['Build.DefinitionName'], '-full')) }}:
        scope: full
      ${{ elseif eq(variables.isPRTrigger, 'true') }}:
        scope: lite
      ${{ else }}:
        scope: full
    ${{ else }}:
      scope: ${{ parameters.buildScope }}
    # Exclude runtime dependent jobs for any branch not producing a 1xx version since runtime-related repos aren't built in that context
    # Will exclude runtime-dependent jobs when either of the following are true:
    #   - 'Detect By Branch Name' was selected for the feature band: branch is not main and does not contain '.1xx' but does end with 'xx'.
    #   - '>= 2xx' was selected for the feature band
    # This handles both PR and manually run builds as the variables are different between the two contexts
    # Note that for manually run builds, the user must select '>= 2xx' when targeting a custom branch
    ${{ if or(and(eq(parameters.featureBand, 'Detect by Branch Name'), eq(variables.isPRTrigger, 'true'), ne(variables['System.PullRequest.TargetBranch'], 'refs/heads/main'), not(contains(variables['System.PullRequest.TargetBranch'], '.1xx')), endsWith(variables['System.PullRequest.TargetBranch'], 'xx')), and(eq(parameters.featureBand, 'Detect by Branch Name'), ne(variables.isPRTrigger, 'true'), ne(variables['Build.SourceBranch'], 'refs/heads/main'), not(contains(variables['Build.SourceBranch'], '.1xx')), endsWith(variables['Build.SourceBranch'], 'xx')), eq(parameters.featureBand, '>= 2xx')) }}:
      excludeRuntimeDependentJobs: true
