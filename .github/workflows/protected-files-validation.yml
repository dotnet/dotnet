name: 'Check Protected Files for Changes'

on:
  pull_request:
    paths:
      - eng/common/**/*
      - eng/Version.Details.xml
      - eng/Versions.props

permissions:
  pull-requests: read

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      repo-path: ${{ steps.set-repo-path.outputs.repo-path }}
    if: ${{ github.event.pull_request.title !~ '^(rebootstrap|re-bootstrap|release|\.NET Source-Build .* Updates)' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch from upstream
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Set up .NET
        run: |
          . eng/common/tools.sh
          InitializeDotNetCli true

      - name: Set repo path
        id: set-repo-path
        run: echo "repo-path=$GITHUB_WORKSPACE" >> $GITHUB_OUTPUT

  check-version-details:
    runs-on: ubuntu-22.04
    needs: setup
    if: ${{ github.event.pull_request.title !~ '^(rebootstrap|re-bootstrap|release|\.NET Source-Build .* Updates)' }}
    steps:
      - name: Check for Version.Details.xml changes
        working-directory: ${{ needs.setup.outputs.repo-path }}
        run: |
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }} | grep '^eng/Version.Details.xml$' >/dev/null; then
            echo "Version.Details.xml has changed."
            exit 1
          else
            echo "No changes in Version.Details.xml."
          fi

  check-versions-props:
    runs-on: ubuntu-22.04
    needs: setup
    if: ${{ github.event.pull_request.title !~ '^(rebootstrap|re-bootstrap|release|\.NET Source-Build .* Updates)' }}
    steps:
      - name: Check for Versions.props changes
        working-directory: ${{ needs.setup.outputs.repo-path }}
        run: |
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }} | grep '^eng/Versions.props$' >/dev/null; then
            echo "Versions.props has changed."
            exit 1
          else
            echo "No changes in Versions.props."
          fi

  check-eng-common:
    runs-on: ubuntu-22.04
    needs: setup
    if: ${{ github.event.pull_request.title !~ '^(rebootstrap|re-bootstrap|release|\.NET Source-Build .* Updates)' }}
    steps:
      - name: Check for eng/common changes
        working-directory: ${{ needs.setup.outputs.repo-path }}
        run: |
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }} | grep '^eng/common/' >/dev/null; then
            echo "Changes detected in eng/common."
            exit 1
          else
            echo "No changes in eng/common."
          fi
